name: Test

on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: "üîß Checkout code"
        uses: actions/checkout@v4

      - name: "üß™ Verify project structure"
        run: |
          echo "Verifying project structure..."
          
          # Check for required directories
          if [ ! -d "BP" ]; then
            echo "‚ùå BP directory not found"
            exit 1
          fi
          
          if [ ! -d "RP" ]; then
            echo "‚ùå RP directory not found"
            exit 1
          fi
          
          # Check for required files
          if [ ! -f "BP/manifest.json" ]; then
            echo "‚ùå BP/manifest.json not found"
            exit 1
          fi
          
          if [ ! -f "RP/manifest.json" ]; then
            echo "‚ùå RP/manifest.json not found"
            exit 1
          fi
          
          if [ ! -f "version.json" ]; then
            echo "‚ùå version.json not found"
            exit 1
          fi
          
          # Check for release template
          if [ ! -f ".github/templates/release.md" ]; then
            echo "‚ùå .github/templates/release.md not found"
            exit 1
          fi
          
          echo "‚úÖ Project structure verified"

      - name: "üîç Validate JSON files"
        run: |
          echo "Validating JSON files..."
          
          # Validate BP manifest
          if ! jq empty BP/manifest.json; then
            echo "‚ùå BP/manifest.json is invalid JSON"
            exit 1
          fi
          
          # Validate RP manifest
          if ! jq empty RP/manifest.json; then
            echo "‚ùå RP/manifest.json is invalid JSON"
            exit 1
          fi
          
          # Validate version.json
          if ! jq empty version.json; then
            echo "‚ùå version.json is invalid JSON"
            exit 1
          fi
          
          echo "‚úÖ All JSON files are valid"

      - name: "üìä Check project statistics"
        run: |
          echo "Project statistics:"
          echo "üì¶ BP files: $(find BP -type f | wc -l)"
          echo "üì¶ RP files: $(find RP -type f | wc -l)"
          echo "üì¶ Total files: $(find BP RP -type f | wc -l)"
          
          if [ -d "BP/blocks" ]; then
            echo "‚èπÔ∏è Block files: $(find BP/blocks -name "*.block.json" | wc -l)"
          fi
          
          echo "‚úÖ Project statistics collected"
